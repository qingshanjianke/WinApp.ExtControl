name: .NET Class Library CI/CD - Trusted Publishing

on:
  push:
    tags:
      - 'v*'   # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  id-token: write    # âœ… å¿…é¡»ï¼Œå…è®¸ GitHub å‘ OIDC ä»¤ç‰Œ
  contents: read

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: './WinApp.ExtControl.csproj'
  CONFIGURATION: 'Release'
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'

jobs:
  build-and-publish:
    runs-on: windows-latest  # âœ… ä¿ç•™ Windows æ„å»ºç¯å¢ƒ

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ” æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "è¿è¡Œå™¨æ“ä½œç³»ç»Ÿ: Windows"
        dotnet --info
        dotnet --list-sdks

    - name: ğŸ§© è¿˜åŸä¾èµ–
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: dotnet test ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-build --logger "trx;LogFileName=test_results.trx"

    - name: ğŸ“¦ æ‰“åŒ… NuGet åŒ…
      run: dotnet pack ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-build --output ./artifacts

    # ğŸŒŸ æ–°å¢ï¼šä½¿ç”¨ OIDC ç™»å½• NuGet.org è·å–ä¸´æ—¶ API Key
    - name: ğŸ” è®¤è¯åˆ° NuGet.orgï¼ˆTrusted Publishingï¼‰
      id: login
      uses: NuGet/login@v1
      with:
        user: qingshanjianke

    # ğŸš€ å‘å¸ƒåŒ…
    - name: ğŸš€ å‘å¸ƒåˆ° NuGet.org
      run: dotnet nuget push "artifacts/*.nupkg" ^
             --api-key ${{ steps.login.outputs.NUGET_API_KEY }} ^
             --source ${{ env.NUGET_SOURCE }} ^
             --skip-duplicate
