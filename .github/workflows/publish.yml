name: Publish NuGet Package (Trusted Publishing)

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  id-token: write   # âœ… å¿…é¡»: å…è®¸ OIDC ç™»å½• NuGet.org
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x  # æˆ– 8.0.xï¼Œæ ¹æ®ä½ çš„é¡¹ç›®ç‰ˆæœ¬è°ƒæ•´

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Pack
        run: dotnet pack --configuration Release --no-build --output ./artifacts

      # ğŸŒŸ æ–°å¢ï¼šä½¿ç”¨ OIDC ç™»å½• NuGet.org è·å–ä¸´æ—¶ API Key
      - name: Authenticate to NuGet.org (Trusted Publishing)
        id: login
        uses: NuGet/login@v1
        with:
          nuget-service: nuget.org
          user: qingshanjianke

      # ğŸš€ å‘å¸ƒ NuGet åŒ…
      - name: Publish package to NuGet.org
        run: dotnet nuget push "artifacts/*.nupkg" \
               --api-key ${{ steps.login.outputs.NUGET_API_KEY }} \
               --source https://api.nuget.org/v3/index.json \
               --skip-duplicate
