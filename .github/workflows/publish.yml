name: .NET Class Library CI/CD - Windows

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]  # ä»…åœ¨åˆ›å»ºGitHub Releaseæ—¶è§¦å‘å‘å¸ƒ

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/YourClassLibrary/YourClassLibrary.csproj'
  CONFIGURATION: 'Release'
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'

jobs:
  build-and-test:
    runs-on: windows-latest  # ä½¿ç”¨Windowsè¿è¡Œå™¨

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ” æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "è¿è¡Œå™¨æ“ä½œç³»ç»Ÿ: Windows"
        dotnet --info
        dotnet --list-sdks

    - name: ğŸ§© è¿˜åŸä¾èµ–
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: dotnet test ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-build --logger "trx" --results-directory "TestResults"

    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿä¸Šä¼ ç»“æœ
      with:
        name: test-results-windows
        path: TestResults/
        retention-days: 7

  pack:
    runs-on: windows-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'release'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ æ‰“åŒ… NuGet åŒ…
      run: |
        dotnet pack ${{ env.PROJECT_PATH }} `
          --configuration ${{ env.CONFIGURATION }} `
          --output ./nupkg `
          --include-symbols `
          --include-source `
          -p:SymbolPackageFormat=snupkg `
          -p:VersionSuffix=${{ github.run_number }} `
          -p:ContinuousIntegrationBuild=true

    - name: ğŸ’¾ ä¿å­˜ NuGet åŒ…åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: nupkg/*.nupkg
        retention-days: 10

  trusted-publish:
    runs-on: windows-latest
    needs: pack
    # ä»…åœ¨åˆ›å»ºReleaseæ—¶æ‰§è¡Œå¯ä¿¡å‘å¸ƒ
    if: github.event_name == 'release'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¥ ä¸‹è½½ NuGet åŒ…åˆ¶å“
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: nupkg/

    - name: ğŸ” NuGet å¯ä¿¡å‘å¸ƒåˆ°å®˜æ–¹æº
      run: |
        # éªŒè¯åŒ…æ–‡ä»¶å­˜åœ¨
        Get-ChildItem nupkg/*.nupkg | ForEach-Object { 
          Write-Host "å‡†å¤‡å‘å¸ƒåŒ…: $($_.Name)" 
        }
        
        # æ‰§è¡Œå¯ä¿¡å‘å¸ƒ
        dotnet nuget push nupkg/*.nupkg `
          --api-key ${{ secrets.NUGET_API_KEY }} `
          --source ${{ env.NUGET_SOURCE }} `
          --skip-duplicate `
          --timeout 600
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    - name: ğŸ·ï¸ å‘å¸ƒç¬¦å·åŒ…
      run: |
        dotnet nuget push nupkg/*.snupkg `
          --api-key ${{ secrets.NUGET_API_KEY }} `
          --source ${{ env.NUGET_SOURCE }} `
          --skip-duplicate `
          --timeout 600
      if: success()  # åªæœ‰ä¸»åŒ…å‘å¸ƒæˆåŠŸåæ‰å‘å¸ƒç¬¦å·åŒ…