name: Publish Release Package

on:
  push:
    branches: [ "master" ]    # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    tags:
      - "v**"
  pull_request:
    branches: [ "master" ]

env:
  DOTNET_VERSION: '8.0.x' # å¯æ ¹æ®é¡¹ç›®éœ€è¦è°ƒæ•´.NETç‰ˆæœ¬
  PROJECT_PATH: 'WinApp.ExtControl/WinApp.ExtControl.csproj' # æ›¿æ¢ä¸ºä½ çš„é¡¹ç›®è·¯å¾„
  CONFIGURATION: 'Release'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ§© è¿˜åŸä¾èµ–
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: ğŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: dotnet test ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal

  pack-and-publish:
    runs-on: ubuntu-latest
    needs: build-and-test # ä¾èµ–äº build-and-test ä»»åŠ¡
    # ä»…å½“æ¨é€åˆ° main åˆ†æ”¯ä¸” build-and-test ä»»åŠ¡æˆåŠŸæ—¶è¿è¡Œ
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build-and-test.result == 'success'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ æ‰“åŒ… NuGet åŒ…
      run: dotnet pack ${{ env.PROJECT_PATH }} --configuration ${{ env.CONFIGURATION }} --output ./nupkg --include-symbols

    - name: ğŸš€ å‘å¸ƒåˆ° NuGet.org
      run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate